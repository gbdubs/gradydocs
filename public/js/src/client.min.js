$(document).ready(function(){function n(n){var e=J[n%J.length],t=".chunk.listening-"+n+" { position: relative; padding-right: 2px; }\n.chunk.listening-"+n+":after { background-color: "+e+'; content: ""; position: absolute; display: inline-block; height: 100%; width: 2px; bottom: 0px; border-radius: 1px; }\n.chat-message-'+n+" { background-color: "+e+"; }\n";n==myCursorId&&(t+=".header{ background: "+e+" !important;}\n",t+=".chunk.listening-"+n+":after{ -webkit-animation: 1s blink step-end infinite;-moz-animation: 1s blink step-end infinite;-ms-animation: 1s blink step-end infinite;-o-animation: 1s blink step-end infinite;animation: 1s blink step-end infinite;\n.chunk.listening-"+n+":after { background-color: "+e+" !important; }"),head=document.head||document.getElementsByTagName("head")[0],style=document.createElement("style"),style.type="text/css",style.styleSheet?style.styleSheet.cssText=t:style.appendChild(document.createTextNode(t)),head.appendChild(style)}function e(e){return O[e]={cursorId:e,location:-1,element:void 0,place:function(n){var e={commandType:D(),cursorId:this.cursorId,newLocation:n};w(e),g(e)},move:function(n){void 0!=this.element&&$(this.element).removeClass("listening-"+this.cursorId),this.location=n,this.element=z[this.location].element,$(this.element).addClass("listening-"+this.cursorId)},left:function(){var n=z[this.location].previousChunk;void 0!=n&&-1!=n&&(z[n].placeholder&&(n=z[n].previousChunk),this.place(n))},right:function(){var n=z[this.location].nextChunk;void 0!=n&&(z[n].placeholder&&(n=z[n].nextChunk),this.place(n))},up:function(){for(var n=z[this.location],e=$(n.element).position().left;"\r"!=n.content&&void 0!=n&&void 0!=n.previousChunk;)n=z[n.previousChunk];if(void 0!=n){if(void 0==n.previousChunk)return void this.place(n.id);for(n=z[n.previousChunk];void 0!=n&&"\r"!=n.content;){if($(n.element).position().left<=e)return void this.place(n.id);n=z[n.previousChunk]}}},down:function(){for(var n=z[this.location],e=$(n.element).position().left;"\r"!=n.content&&void 0!=n&&void 0!=n.nextChunk;)n=z[n.nextChunk];if(void 0!=n){if(void 0==n.nextChunk)return void this.place(n.id);for(n=z[n.nextChunk];void 0!=n&&"\r"!=n.content&&void 0!=n.nextChunk;){if($(n.element).position().left>=e)return void this.place(n.id);n=z[n.nextChunk]}return void 0!=n?void this.place(n.id):void 0}}},n(e),O[e]}function t(){var n=u(1);n.content="";var t=n.createElement();$("#chunks").append(t),n.element=$("#chunk-1")[0],$(".document-id").each(function(){$(this).text(S)}),$.get("/user-number-plz/"+S,function(n){myCursorId=parseInt(n),U=e(myCursorId),U.place(1);var t=2+1e7*myCursorId;A=t,$.get("/catchup-plz/"+S,function(n){var e=JSON.parse(n);for(var t in e)w(JSON.parse(e[t]))})}),$("#download-btn").click(function(){m()}),$("#save-btn").click(function(){m()}),$("#chat-send-btn").click(h),$(".chat-toggle-tools > span").click(f);var i=document.getElementById("chunks");i.onpaste=function(n){var e=void 0;return window.clipboardData&&window.clipboardData.getData?e=window.clipboardData.getData("Text"):n.clipboardData&&n.clipboardData.getData&&(e=n.clipboardData.getData("text/plain")),void 0!=e&&a(e),!1},M=io(),M.emit("joining",S),M.on("modification",function(n){w(JSON.parse(n))}),M.on("chat",function(n){w(JSON.parse(n))}),$(window).keydown(function(n){var e=n.which;"INPUT"==document.activeElement.tagName?13==e&&h():8==e?(c(),n.preventDefault()):13==e?(o(13),o(-1),n.preventDefault()):9==e?(o(9),n.preventDefault()):37==e?U.left():39==e?U.right():38==e?U.up():40==e&&U.down()}),$(window).keypress(function(n){var e=n.which;"INPUT"!=document.activeElement.tagName&&(e>=32&&126>=e&&o(e),32==e&&n.preventDefault()),8==e&&n.preventDefault()}),$("#false-input").focus()}function i(n,e,t){var i=u(t,n);i.placeholder=""==e;var o=i.id;i.content=e;var a=i.createElement();return $(z[n].element).after(a),i.element=$("#chunk-"+o)[0],$(i.element).click(function(){U.place(o)}),o}function o(n){var e=void 0;e=-1==n?"":String.fromCharCode(n);var t={commandType:x(),afterChunk:U.location,content:e,newChunkId:A++};w(t),g(t),U.place(t.newChunkId)}function a(n){for(var e=0;e<n.length;e++)o(n.charCodeAt(e))}function r(n){var e=z[n],t=e.previousChunk;for(var i in O)$(e.element).hasClass("listening-"+i)&&O[i].place(t);var o=(e.placeholder,e.element);d(e.id),o.remove()}function c(){if(1!=U.location){var n=z[U.location].placeholder,e={commandType:I(),chunkDeleted:U.location};w(e),g(e),n&&c()}}function u(n,e){var t={id:n,content:"",previousChunk:void 0,nextChunk:void 0,createElement:function(){return'<span class="chunk" id="chunk-'+this.id+'">'+this.content+"</span>"}};if(z[t.id]=t,void 0==e||null==e||void 0==L){var i=L;return L=t.id,t.nextChunk=i,void 0!=z[i]&&(z[i].previousChunk=t.id),t}var o=z[e];if(void 0===o)throw"The chunk with id ["+e+"] does not exist.";var a=z[o.nextChunk];return t.previousChunk=o.id,o.nextChunk=t.id,void 0!=a&&(a.previousChunk=t.id,t.nextChunk=a.id),t}function d(n){var e=z[n];if(void 0==e)throw"The chunk with id ["+n+"] does not exist.";var t=z[e.previousChunk],i=z[e.nextChunk];void 0!=t&&void 0==i?t.nextChunk=void 0:void 0==t&&void 0!=i?L=i.id:void 0!=t&&void 0!=i&&(t.nextChunk=i.id,i.previousChunk=t.id),delete z[n]}function s(n,e){var t='<div class="chat-message chat-message-'+n+'">'+e+"</div>";$(".chat-messages").first().append(t),P++,v()}function l(n){var e={commandType:E(),cursorId:U.cursorId,message:n};g(e),w(e),P=0,v()}function h(){var n=$("#chat-field-input"),e=n.val();0!=e.trim().length&&(l(e),n.val(""))}function v(){$(".chat-waiting").first().text(P)}function f(){$(".chat-toggle-tools > span").each(function(){$(this).toggleClass("hidden")}),$(".chat-body").toggleClass("minimized")}function p(){for(var n="",e=L;e;)n+=z[e].content,e=z[e].nextChunk;return n}function m(){var n=p(),e="data:text/plain;charset=utf-8,"+encodeURIComponent(n);window.open(e,"_blank")}function k(n){var e=[];return n.commandType&&(e.t=n.commandType),n.afterChunk&&(e.a=n.afterChunk),n.content&&(e.c=n.content),n.newChunkId&&(e.n=n.newChunkId),n.chunkDeleted&&(e.d=n.chunkDeleted),n.cursorId&&(e.i=n.cursorId),n.newLocation&&(e.l=n.newLocation),n.message&&(e.m=n.message),n.docUuid&&(e.u=n.docUuid),e}function C(n){if(n.commandType)return n;var e=[];return n.t&&(e.commandType=n.t),n.a&&(e.afterChunk=n.a),n.c&&(e.content=n.c),n.n&&(e.newChunkId=n.n),n.d&&(e.chunkDeleted=n.d),n.i&&(e.cursorId=n.i),n.l&&(e.newLocation=n.l),n.m&&(e.message=n.m),n.u&&(e.docUuid=n.u),e}function g(n){n.docUuid=S;k(n);M.emit("modification",JSON.stringify(n))}function w(n){n=C(n);var e=n.commandType;y(e)?F.insert(n.afterChunk,n.content,n.newChunkId):b(e)?F["delete"](n.chunkDeleted):T(e)?F.moveCursor(n.cursorId,n.newLocation):N(e)&&F.addChatMessage(n.cursorId,n.message)}function x(){return 1}function y(n){return 1==n}function I(){return 2}function b(n){return 2==n}function D(){return 3}function T(n){return 3==n}function E(){return 4}function N(n){return 4==n}var F={},B=window.location.href,S=B.substring(B.lastIndexOf("/")+1),U=void 0,O={},J=["#000000","#3F51B5","#4CAF50","#FFC107","#2196F3","#FF5722","#009688","#FFEB3B","#673AB7","#F44336","#9C27B0","#CDDC39","#E91E63","#607D8B"];F.moveCursor=function(n,t){void 0==O[n]&&(O[n]=e(n)),O[n].move(t)};var L=void 0,z={},A=-1,M=void 0;F.setup=t,F.insert=i,F["delete"]=r;var P=0;F.addChatMessage=s,t()});